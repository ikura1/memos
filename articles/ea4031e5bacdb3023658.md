---
title: "`pre-commit`ã‚’`Github Actions`ã§å®Ÿè¡Œã™ã‚‹"
emoji: "ğŸ•"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["CI", "Python", "Github"]
published: true
---

## ã¯ã˜ã‚ã«

ã“ã®è¨˜äº‹ã¯ã€`cookiecutter-django`ã§ä½¿ç”¨ã•ã‚Œã¦ã„ã‚‹`pre-commit`ã¨`Github Actions`ã®å‹•ä½œã‚’ç†è§£ã™ã‚‹ãŸã‚ã®è¨˜äº‹ã§ã™ã€‚
`pre-commit`ã‚’ç”¨ã„ã¦ã€ã‚³ãƒ¼ãƒ‰ã®æ•´å½¢ã‚„å‹ãƒã‚§ãƒƒã‚¯ã‚’è¡Œãˆã¾ã™ã€‚ãã‚Œã‚’`GithubAction`ã§`pre-commit`ã‚’å®Ÿè¡Œã™ã‚‹ã“ã¨ã§ç’°å¢ƒæ§‹ç¯‰ã®å¿…è¦ã‚’ãªãã—ã¾ã™ã€‚

**ã‚µãƒ³ãƒ—ãƒ«ãƒªãƒã‚¸ãƒˆãƒª**
https://github.com/ikura1/test-pre-commit

## `pre-commit`ã®å†…å®¹ã‚’èª­ã‚€

`GithubActions`ã§å®Ÿè¡Œã•ã›ã‚‹å‰ã«`pre-commit`ã§ä½•ãŒå®Ÿè¡Œã•ã‚Œã‚‹ã‚ˆã†ã«ãªã£ã¦ã„ã‚‹ã®ã‹èª­ã‚“ã§ã„ãã¾ã™ã€‚

```yml
exclude: "^docs/|/migrations/"
default_stages: [commit]

repos:
  - repo: https://github.com/pre-commit/pre-commit-hooks
    rev: v4.2.0
    hooks:
      - id: trailing-whitespace
      - id: end-of-file-fixer
      - id: check-yaml

  - repo: https://github.com/psf/black
    rev: 22.3.0
    hooks:
      - id: black

  - repo: https://github.com/PyCQA/isort
    rev: 5.10.1
    hooks:
      - id: isort

  - repo: https://github.com/PyCQA/flake8
    rev: 4.0.1
    hooks:
      - id: flake8
        args: ["--config=setup.cfg"]
        additional_dependencies: [flake8-isort]

# sets up .pre-commit-ci.yaml to ensure pre-commit dependencies stay up to date
ci:
  autoupdate_schedule: weekly
  skip: []
  submodules: false
```

### å®Ÿè¡Œã•ã‚Œã‚‹ã‚³ãƒãƒ³ãƒ‰

`repos`å†…ã®ã‚³ãƒãƒ³ãƒ‰ãŒé †ã«å®Ÿè¡Œã•ã‚Œã¦ã„ãã®ã§ä¸‹è¨˜ã®æ§˜ã«ãªã£ã¦ã„ã¾ã™ã€‚

- `pre-commit-hooks`
  - `trailing-whitespace`
    - è¡Œæœ«ã®ã‚¹ãƒšãƒ¼ã‚¹å‰Šé™¤
    - ç©ºè¡Œã®å‰Šé™¤
  - `end-of-file-fixer`
    - ãƒ•ã‚¡ã‚¤ãƒ«ã®æœ«å°¾ã‚’ç©ºè¡Œã«å¤‰æ›´
  - `check-yaml`
    - `yaml` ãƒ•ã‚¡ã‚¤ãƒ«ã®æ§‹æ–‡ãƒã‚§ãƒƒã‚¯
- `black`
  - ã‚³ãƒ¼ãƒ‰ã®æ•´å½¢
- `isort`
  - import ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®æ•´å½¢
- `flake8`
  - ã‚³ãƒ¼ãƒ‰ã®ã‚¹ã‚¿ã‚¤ãƒ«ãƒã‚§ãƒƒã‚¯

### ãã®ä»–

- `exclude`
  - é™¤å¤–ã•ã‚Œã‚‹ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¿ãƒ¼ãƒ³ã®å®šç¾©
  - ã“ã“ã§ã¯ã€ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆãƒ•ã‚©ãƒ«ãƒ€ãƒ¼ã¨ DB ã®ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒ•ã‚©ãƒ«ãƒ€ãƒ¼ãŒæŒ‡å®šã•ã‚Œã¦ã„ã‚‹
- `default_stages`
  - å®Ÿè¡Œã™ã‚‹æ®µéšã®å®šç¾©
  - hooks ã®å®Ÿè¡Œã¯`commit`æ™‚ã«åˆ¶é™ã•ã‚Œã¦ã„ã‚‹
- `ci`
  - `pre-commit`ã®`ci`å‘ã‘è¨­å®š
  - `autoupdate_schedule`
    - hook ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’æ›´æ–°ã™ã‚‹ãŸã‚ã®ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«
    - `weekly`ãŒæŒ‡å®šã•ã‚Œã¦ãŠã‚Šã€æ¯é€±æ›´æ–°ã•ã‚Œã‚‹
  - `skip`
    - ã‚¹ã‚­ãƒƒãƒ—ã™ã‚‹ hookID ã®ãƒªã‚¹ãƒˆã‚’æŒ‡å®š
    - ã‚¹ã‚­ãƒƒãƒ—ã¯ã—ãªã„ã‚ˆã†ã«è¨­å®šã•ã‚Œã¦ã„ã‚‹
  - `submodules`
    - ã‚µãƒ–ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã®å†å¸°çš„ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆã®è¨­å®š
    - `false`ã€ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚‚`false`

## ç’°å¢ƒæ§‹ç¯‰

ã¾ãšã¯ãƒ­ãƒ¼ã‚«ãƒ«ç’°å¢ƒã§`pre-commit`ãŒå®Ÿè¡Œã§ãã‚‹ã‚ˆã†ã«ç’°å¢ƒã‚’æ§‹ç¯‰ã—ã¾ã™ã€‚

```txt
# Code quality
# ------------------------------------------------------------------------------
flake8==4.0.1  # https://github.com/PyCQA/flake8
flake8-isort==4.1.1  # https://github.com/gforcada/flake8-isort
coverage==6.3.2  # https://github.com/nedbat/coveragepy
black==22.3.0  # https://github.com/psf/black
pylint-django==2.5.3  # https://github.com/PyCQA/pylint-django
pre-commit==2.18.1  # https://github.com/pre-commit/pre-commit
```

ä¸Šè¨˜ã¯ãƒ­ãƒ¼ã‚«ãƒ«ç’°å¢ƒç”¨ã®`requirements.txt`ã§ã®ã‚³ãƒ¼ãƒ‰å“è³ªéƒ¨åˆ†ã«ãªã‚Šã¾ã™ã€‚

ä¸‹è¨˜ã® 2 ã¤ã¯`pre-commit`ã§ä½¿ç”¨ã—ãªã„ã®ã§ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¾ã›ã‚“ã§ã—ãŸã€‚

- `coverage`
- `pylint-django`

### `pre-commit`ã®å®Ÿè¡Œãƒ†ã‚¹ãƒˆ

æ•´å½¢ãŒå¿…è¦ãªä¸‹è¨˜ã®ã‚ˆã†ãªã‚³ãƒ¼ãƒ‰ã‚’ä½œæˆã—ã€`pre-commit`ã‚’å‹•ä½œã•ã›ã¾ã™ã€‚
`pre-commit install`ã—ãŸã‚ã¨ã®ç¢ºèªã«ãªã‚Šã¾ã™ã€‚`GithubActions`ã§ã®å‹•ä½œã®ã¨ãã«ã¯`pre-commit install`ã¯ã—ã¦ã„ãªã„çŠ¶æ³ã§å‹•ä½œç¢ºèªã‚’è¡Œã„ã¾ã™ã€‚

```python:hoge.py
import random
from fizzbuzz import fizzbuzz as fb
import click
import os


@click.command()
@click.option('--num','-n',default=lambda: random.randint(1, 100),type=int,help='Number of loop')
def fizzbuzz(num: int):
    fb(num)


if __name__=='__main__':
  fizzbuzz()
```

_`pre-commit`å‹•ä½œãƒ­ã‚°_

```shell-session
$ >git commit -m "feat: isortãªã©ãŒå‹•ä½œã™ã‚‹ã‚³ãƒ¼ãƒ‰ã«å¤‰æ›´"
[WARNING] Unstaged files detected.
[INFO] Stashing unstaged files to C:\Users\ikura\.cache\pre-commit\patch1651315960-10368.
trim trailing whitespace.................................................Passed
fix end of files.........................................................Passed
check yaml...........................................(no files to check)Skipped
black....................................................................Failed
- hook id: black
- files were modified by this hook

reformatted hoge.py

All done! \u2728 \U0001f370 \u2728
1 file reformatted, 1 file left unchanged.

isort....................................................................Failed
- hook id: isort
- files were modified by this hook

Fixing C:\Users\ikura\repos\test-pre-commit\hoge.py

flake8...................................................................Passed
[INFO] Restored changes from C:\Users\ikura\.cache\pre-commit\patch1651315960-10368.

$ >
```

_`pre-commit`å®Ÿè¡Œå¾Œã®ã‚³ãƒ¼ãƒ‰_

```python:hoge.py
import random

import click

from fizzbuzz import fizzbuzz as fb


@click.command()
@click.option(
    "--num",
    "-n",
    default=lambda: random.randint(1, 100),
    type=int,
    help="Number of loop",
)
def fizzbuzz(num: int):
    fb(num)


if __name__ == "__main__":
    fizzbuzz()

```

## `Github Action`éƒ¨åˆ†ã‚’èª­ã‚€

```yaml
name: CI

# Enable Buildkit and let compose use it to speed up image building
env:
  DOCKER_BUILDKIT: 1
  COMPOSE_DOCKER_CLI_BUILD: 1

on:
  pull_request:
    branches: ["master", "main"]
    paths-ignore: ["docs/**"]

  push:
    branches: ["master", "main"]
    paths-ignore: ["docs/**"]

concurrency:
  group: ${{ github.head_ref || github.run_id }}
  cancel-in-progress: true

jobs:
  linter:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code Repository
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v3
        with:
          python-version: "3.9"
          cache: pip
          cache-dependency-path: |
            requirements/base.txt
            requirements/local.txt

      - name: Run pre-commit
        uses: pre-commit/action@v2.0.3

  # With no caching at all the entire ci process takes 4m 30s to complete!
  pytest:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Code Repository
        uses: actions/checkout@v3

      - name: Build the Stack
        run: docker-compose -f local.yml build

      - name: Run DB Migrations
        run: docker-compose -f local.yml run --rm django python manage.py migrate

      - name: Run Django Tests
        run: docker-compose -f local.yml run django pytest

      - name: Tear down the Stack
        run: docker-compose -f local.yml down
```

`jobs`ã®å¾ŒåŠ`pytest`éƒ¨åˆ†ã¯ç„¡è¦–ã™ã‚‹ã€‚èª­ã‚€åˆ†ã«ã¯å‰åŠéƒ¨åˆ†ã§ååˆ†ãªã®ã¨ç°¡æ˜“ã®å‹•ä½œç¢ºèªã¨ã—ã¦ã¯ã€ãƒ†ã‚¹ãƒˆéƒ¨åˆ†ã®å‹•ä½œæ¤œè¨¼ã—ã«ãã„ã€‚

### å®Ÿè¡Œå›ã‚Šã®è¨­å®š

```yaml
on:
  pull_request:
    branches: ["master", "main"]
    paths-ignore: ["docs/**"]

  push:
    branches: ["master", "main"]
    paths-ignore: ["docs/**"]

concurrency:
  group: ${{ github.head_ref || github.run_id }}
  cancel-in-progress: true
```

**å®Ÿè¡Œã™ã‚‹ã‚¿ã‚¤ãƒŸãƒ³ã‚°(`on`)**
ãƒ—ãƒ«ãƒªã‚¯ã‚¨ã‚¹ãƒˆã¨ãƒ—ãƒƒã‚·ãƒ¥æ™‚ã«`master`ã‹`main`ãƒ–ãƒ©ãƒ³ãƒã§å®Ÿè¡Œã™ã‚‹ã€‚ã¾ãŸ`docs`ã¯é™¤å¤–

**ä¸¦è¡Œæ€§([concurrency](https://docs.github.com/ja/actions/using-jobs/using-concurrency))**
å¤‰æ›´å®Ÿè¡Œã‚’è¨±ã•ãšã€åŒæ™‚ã®å ´åˆã¯ãƒ—ãƒ«ãƒªã‚¯ã®ã¿å®Ÿè¡Œ

### å®Ÿè¡Œéƒ¨åˆ†

```yaml
linter:
  runs-on: ubuntu-latest
  steps:
    - name: Checkout Code Repository
      uses: actions/checkout@v3

    - name: Set up Python
      uses: actions/setup-python@v3
      with:
        python-version: "3.9"
        cache: pip
        cache-dependency-path: |
          requirements/base.txt
          requirements/local.txt

    - name: Run pre-commit
      uses: pre-commit/action@v2.0.3
```

- actions/checkout@3
  - ã‚³ãƒ¼ãƒ‰ã®ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
- actions/setup-python@v3
  - Python ã® Setup
  - å‹•ä½œç¢ºèªã§ã¯ã€`requirements.txt` ã«å¤‰æ›´
- pre-commit/action@v2.0.3
  - `pre-commit` ã®å®Ÿè¡Œ

### å‹•ä½œç¢ºèª

`pre-commit uninstall`ã§`pre-commit`ã‚’å‰Šé™¤ã—ã€ä¸Šã§ä½œã£ãŸæ‚²ã—ã¿ã®ã‚³ãƒ¼ãƒ‰ã‚’ãƒ—ãƒƒã‚·ãƒ¥ã—ã¦å‹•ä½œã‚’ç¢ºèªã—ã¦ã¿ã¾ã™ã€‚
ã‚³ãƒ¼ãƒ‰ã‚’ãƒ—ãƒƒã‚·ãƒ¥ãƒ»ãƒ—ãƒ«ãƒªã‚¯ã‚’ã™ã‚‹ã¨ã€`Github Actions`ã§å¤±æ•—ã—ã€ä¿®æ­£ãŒæ±‚ã‚ã‚‰ã‚Œã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã—ãŸã€‚:o:

![error](/images/precommit-githubactions/pullrequest.png)

## æ‰€æ„Ÿ

`Github Actions`è‰¯ã„ãªãƒ¼ã¨ã„ã†ãŠæ°—æŒã¡
`pre-commit`ã¯æœ€çµ‚çš„ã«ã¯ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒãƒ­ãƒ¼ã‚«ãƒ«ã«ç’°å¢ƒã‚’æ§‹ç¯‰ã—ã¦ã„ãªã‘ã‚Œã°é§„ç›®ãªã®ã§ã™ãŒã€`Github Actions`ã§å®Ÿè¡Œã™ã‚‹ã“ã¨ã«ã‚ˆã‚ŠäººãŒç’°å¢ƒã«é–¢ä¸ã›ãšãƒã‚§ãƒƒã‚¯ã•ã‚Œã‚‹ã®ãŒè‰¯ã„ã§ã™ã­ã€‚

## å‚™è€ƒ

- `mypy`
  - å‹æ¤œæŸ»ã¯ã‚³ãƒãƒ³ãƒ‰å®Ÿè¡Œ
  - `pre-commit`ã«ã¯å«ã¾ã‚Œã¦ã„ãªã„
- `coverage`
  - ãƒ†ã‚¹ãƒˆã‚¬ãƒãƒ¬ãƒƒã‚¸ã¯ã‚³ãƒãƒ³ãƒ‰å®Ÿè¡Œ

## å‚è€ƒ

https://github.com/cookiecutter/cookiecutter-django
https://pre-commit.com/
https://pre-commit.ci/
https://github.com/pre-commit/pre-commit-hooks
https://github.com/psf/black
https://github.com/PyCQA/isort
https://github.com/PyCQA/flake8
https://docs.github.com/ja/actions/using-jobs/using-concurrency
